<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Where Itâ€™s At Now</title>

  <!-- Google tag (gtag.js) -->
<script async src="https://www.google-analytics.com/gtag/js?id=G-ZGML878333"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZGML878333');
</script>

  <style>
    :root{
      --bg:#fafafa; --card:#fff; --border:#e6e6e6; --text:#111; --muted:#666;
      --pill:#f4f4f4; --btn:#111; --btnText:#fff;
      --radius:14px;
    }
    body{ font-family:system-ui,-apple-system,Segoe UI,Arial; margin:0; background:var(--bg); color:var(--text); }
    header{ position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--border); z-index:5; }
    .wrap{ max-width:980px; margin:0 auto; padding:14px 16px; }
    .topRow{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
    h1{ margin:0; font-size:26px; line-height:1.15; }
    .sub{ margin-top:2px; color:var(--muted); font-size:14px; }
    .rightTop{ display:flex; gap:10px; align-items:center; }
    button{ cursor:pointer; border:1px solid #d7d7d7; border-radius:12px; padding:10px 12px; background:#eee; }
    .primary{ background:var(--btn); color:var(--btnText); border:none; }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; background:var(--pill); border:1px solid #ddd; font-size:13px; color:#333; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px; }
    .card h2{ margin:0 0 4px 0; font-size:20px; }
    input{ width:100%; box-sizing:border-box; padding:10px 12px; border-radius:12px; border:1px solid #d7d7d7; }

    .colLeft{ flex:1 1 360px; min-width:320px; }
    .colRight{ flex:1 1 520px; min-width:320px; }

    .hallItem{ border:1px solid #eee; border-radius:14px; padding:14px; margin-top:10px; }
    .hallTitle{ display:flex; justify-content:space-between; gap:10px; }
    .hallName{ font-weight:800; font-size:22px; margin:0; }
    .hallAddr{ color:var(--muted); margin-top:2px; }
    .hallMeta{ color:#444; margin-top:2px; font-size:14px; }
    .openBtn{ width:100%; margin-top:10px; border-radius:12px; padding:12px; }

    .detailHeader{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .detailTitle{ margin:0; font-size:24px; font-weight:900; line-height:1.1; }
    .detailAddr{ color:var(--muted); margin-top:2px; }

    /* stages: horizontal scroller */
    .stageGrid{
      display:flex;
      flex-wrap: nowrap;
      gap:10px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:8px;
      max-width:100%;
    }
    .stageCard{
      width:170px;
      flex: 0 0 170px;
      max-width:170px;
      border-radius:16px;
      background:#6b6b6b;
      color:#fff;
      padding:12px;
      box-sizing:border-box;
    }
    .stageName{
      font-weight:900;
      font-size:18px;
      line-height:1.1;
      margin:0 0 6px 0;
      white-space:pre-line;
    }
    .stageStats{ font-size:14px; opacity:0.9; }
    .voteBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      border:none;
      background:#000;
      color:#fff;
      border-radius:12px;
      padding:10px 10px;
      width:100%;
      margin-top:10px;
      font-weight:800;
    }
    .voteBtn:disabled{ opacity:0.55; cursor:not-allowed; }

    .note{ color:var(--muted); margin-top:10px; }
    .error{ color:#b00020; white-space:pre-wrap; margin-top:8px; }

    /* Inline open panel (between halls) */
    .inlineDetail{
      margin-top:12px;
      border-top:1px solid #eee;
      padding-top:12px;
    }
    .inlineHdr{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:8px;
    }
    .inlineTitle{
      font-weight:900;
      font-size:18px;
      line-height:1.1;
      margin:0;
    }
    .inlineAddr{
      color:var(--muted);
      margin-top:2px;
      font-size:13px;
    }

    @media (max-width:700px){
      h1{ font-size:22px; }
      .detailTitle{ font-size:20px; }
      .stageCard{ width:160px; flex:0 0 160px; max-width:160px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topRow">
        <div>
          <h1>Where Itâ€™s At Now</h1>
          <div id="locLine" class="sub">Location: not requested</div>
          <div id="errBox" class="error" style="display:none;"></div>
        </div>
        <div class="rightTop">
          <button id="locBtn">Use my location</button>
          <span class="pill" id="devicePill">Device: â€¦</span>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:18px;">
    <div class="card" style="margin-bottom:12px;">
      <div class="row" style="align-items:center;">
        <div style="flex:1 1 320px;">
          <h2 style="margin:0;">Search halls</h2>
          <div class="sub">Outside radius = view only. Inside radius = can thumbs-up.</div>
        </div>
        <div style="flex:2 1 420px;">
          <input id="searchInput" placeholder="Search by hall name" />
        </div>
      </div>
    </div>

    <!-- Admin how-to / instructions box -->
    <div id="adminBox" class="card" style="margin-bottom:12px; display:none;">
      <h2 style="margin:0 0 6px 0;">How to use this site</h2>
      <div id="adminText" class="sub" style="white-space:pre-wrap;"></div>
    </div>

    <div class="row">
      <div class="card colLeft">
        <h2>Halls</h2>
        <div id="hallsBox" class="sub" style="margin-top:10px;">Loadingâ€¦</div>
      </div>

      <div class="card colRight">
        <div class="detailHeader">
          <div>
            <div id="detailTitle" class="detailTitle">Select a hall</div>
            <div id="detailAddr" class="detailAddr"></div>
          </div>
          <span class="pill" id="insidePill">Location not shared</span>
        </div>

        <div id="stagesWrap" style="margin-top:10px; display:none;">
          <div id="stageGrid" class="stageGrid"></div>
          <div id="statusMsg" class="note">View only. Share location and be inside the radius to thumbs-up.</div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, query, where,
      setDoc, serverTimestamp, increment, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAukrjIr-u3dKyCyk-0PTJVoQPcBf2a6-4",
      authDomain: "where-its-at-now.firebaseapp.com",
      projectId: "where-its-at-now",
      storageBucket: "where-its-at-now.firebasestorage.app",
      messagingSenderId: "1082729231123",
      appId: "1:1082729231123:web:3f71893823701fdf3260e6"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Helpers
    const el = (id) => document.getElementById(id);
    const showErr = (msg) => { el("errBox").style.display="block"; el("errBox").textContent = msg; };
    const clearErr = () => { el("errBox").style.display="none"; el("errBox").textContent=""; };

    // Device ID (anonymous)
    const DEVICE_KEY = "wian_device_id";
    let deviceId = localStorage.getItem(DEVICE_KEY);
    if (!deviceId){
      deviceId = Math.random().toString(16).slice(2,10);
      localStorage.setItem(DEVICE_KEY, deviceId);
    }
    el("devicePill").textContent = `Device: ${deviceId}`;

    // Global config
    let globalCfg = {
      defaultResetTimeLocal: "02:00",
      adminText: ""
    };

    async function loadGlobalConfig(){
      clearErr();
      try{
        const snap = await getDoc(doc(db, "config", "global"));
        if (snap.exists()){
          const d = snap.data() || {};
          if (typeof d.defaultResetTimeLocal === "string" && d.defaultResetTimeLocal.trim()){
            globalCfg.defaultResetTimeLocal = d.defaultResetTimeLocal.trim();
          }
          // Admin instructions text (you can store as adminText in config/global)
          if (typeof d.adminText === "string" && d.adminText.trim()){
            globalCfg.adminText = d.adminText;
          } else if (typeof d.howToText === "string" && d.howToText.trim()){
            // optional alternate field name
            globalCfg.adminText = d.howToText;
          }
        }
      }catch(e){
        // Not fatal (site still works)
        showErr("Config read issue:\n" + (e?.message || String(e)));
      }

      const txt = (globalCfg.adminText || "").trim();
      if (txt){
        el("adminText").textContent = txt;
        el("adminBox").style.display = "block";
      } else {
        el("adminBox").style.display = "none";
      }
    }

    // State
    let myLoc = null;
    let myAccuracyFt = null;

    let halls = [];
    let filteredHalls = [];
    let selectedHall = null;

    // LIVE stats listener state
    let unsubStageStats = null;
    let liveStats = {};
    let liveDayKey = null;

    // Default stages (used if a hall has no stages subcollection yet)
    const DEFAULT_STAGES = [
      { id:"chosson_tish_badeken", name:"Chosson Tish\n& Badeken" },
      { id:"chuppah",             name:"Chuppah" },
      { id:"first_course",        name:"First\nCourse" },
      { id:"first_dance",         name:"First\nDance" },
      { id:"main_course",         name:"Main\nCourse" },
      { id:"second_dance",        name:"Second\nDance" },
      { id:"dessert",             name:"Dessert" },
      { id:"benching_wrapup",     name:"Benching/\nWrap-up" },
    ];

    // Haversine distance (feet)
    function feetBetween(a, b){
      const R = 6371000;
      const toRad = (x)=>x*Math.PI/180;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat);
      const lat2 = toRad(b.lat);
      const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(s), Math.sqrt(1-s));
      const meters = R * c;
      return meters * 3.28084;
    }

    // Reset-day key based on hall reset time
    function dayKeyFromReset(resetTimeHHMM){
      const [hh, mm] = String(resetTimeHHMM || globalCfg.defaultResetTimeLocal || "02:00").split(":").map(Number);
      const H = Number.isFinite(hh) ? hh : 2;
      const M = Number.isFinite(mm) ? mm : 0;

      const now = new Date();
      const resetToday = new Date(now);
      resetToday.setHours(H, M, 0, 0);

      const effective = (now < resetToday)
        ? new Date(now.getTime() - 24*60*60*1000)
        : now;

      const y = effective.getFullYear();
      const m = String(effective.getMonth()+1).padStart(2,"0");
      const d = String(effective.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }

    function effectiveResetTimeLocal(hall){
      // hall.resetTimeLocal overrides global default; if missing use global default
      return (hall?.resetTimeLocal || globalCfg.defaultResetTimeLocal || "02:00");
    }

    // radiusFeet standard with fallback
    function hallRadiusFeet(hall){
      const r = hall?.radiusFeet ?? hall?.radiusFt ?? 800;
      const n = Number(r);
      return Number.isFinite(n) ? n : 800;
    }

    function hallLatLng(hall){
      const lat = hall?.geo?.lat ?? hall?.lat;
      const lng = hall?.geo?.lng ?? hall?.lng;
      if (typeof lat !== "number" || typeof lng !== "number") return null;
      return { lat, lng };
    }

    function hallDistanceFeet(hall){
      if (!myLoc) return null;
      const p = hallLatLng(hall);
      if (!p) return null;
      return feetBetween(myLoc, p);
    }

    // LIVE listener for stage stats
    function startStageStatsListener(){
      if (unsubStageStats) { unsubStageStats(); unsubStageStats = null; }
      liveStats = {};
      liveDayKey = null;

      if (!selectedHall) return;

      const resetTime = effectiveResetTimeLocal(selectedHall);
      const dayKey = dayKeyFromReset(resetTime);
      liveDayKey = dayKey;

      const statsCol = collection(db, "halls", selectedHall.id, "days", dayKey, "stageStats");

      unsubStageStats = onSnapshot(statsCol, (snap) => {
        const map = {};
        snap.forEach(d => map[d.id] = d.data());
        liveStats = map;
        // update UI immediately when any device votes
        renderStages(); // updates right panel + inline panel
      }, (err) => {
        showErr("Stage stats live error:\n" + (err?.message || String(err)));
      });
    }

    // Load halls (enabled only)
    async function loadHalls(){
      clearErr();
      try{
        const qs = query(collection(db, "halls"), where("enabled", "==", true));
        const snap = await getDocs(qs);
        halls = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        applySearch();
      }catch(e){
        showErr("Halls read issue:\n" + (e?.message || String(e)));
        halls = [];
        filteredHalls = [];
        renderHallList();
      }
    }

    function applySearch(){
      const qtxt = el("searchInput").value.trim().toLowerCase();
      filteredHalls = halls.filter(h => (h.name || "").toLowerCase().includes(qtxt));
      renderHallList();

      if (selectedHall){
        const still = halls.find(h=>h.id===selectedHall.id);
        if (!still){
          selectedHall = null;
          stopLive();
          renderDetailsEmpty();
        } else {
          selectedHall = still;
          renderDetailsSelected();
        }
      }
    }

    function stopLive(){
      if (unsubStageStats) { unsubStageStats(); unsubStageStats = null; }
      liveStats = {};
      liveDayKey = null;
    }

    function alphaName(h){
      return String(h?.name || h?.id || "").toLowerCase();
    }

    // Render hall list
    // NEW: closest hall to you goes to the top (when location is shared)
    // NEW: "Open" shows inline panel under that hall (between halls)
    function renderHallList(){
      const box = el("hallsBox");
      box.innerHTML = "";

      if (!filteredHalls.length){
        box.textContent = "No halls found.";
        return;
      }

      // sort: closest first (if we have location + geo), otherwise alphabetical
      const sorted = [...filteredHalls].sort((a,b)=>{
        if (!myLoc){
          return alphaName(a).localeCompare(alphaName(b));
        }
        const da = hallDistanceFeet(a);
        const dbb = hallDistanceFeet(b);
        const aHas = da != null;
        const bHas = dbb != null;
        if (aHas && bHas){
          if (da !== dbb) return da - dbb;
          return alphaName(a).localeCompare(alphaName(b));
        }
        if (aHas && !bHas) return -1;
        if (!aHas && bHas) return 1;
        return alphaName(a).localeCompare(alphaName(b));
      });

      sorted.forEach(h => {
        const dist = hallDistanceFeet(h);
        const radius = hallRadiusFeet(h);
        const resetTime = effectiveResetTimeLocal(h);

        const inside = (dist != null) ? (dist <= radius) : false;

        const item = document.createElement("div");
        item.className = "hallItem";

        const titleRow = document.createElement("div");
        titleRow.className = "hallTitle";

        const left = document.createElement("div");
        const name = document.createElement("div");
        name.className = "hallName";
        name.textContent = h.name || h.id;

        const addr = document.createElement("div");
        addr.className = "hallAddr";
        addr.textContent = h.address || "";

        const meta = document.createElement("div");
        meta.className = "hallMeta";
        meta.textContent = `Radius: ${radius} ft Â· Reset: ${resetTime}`;

        left.appendChild(name);
        left.appendChild(addr);
        left.appendChild(meta);

        const right = document.createElement("div");
        const pill = document.createElement("span");
        pill.className = "pill";

        if (!myLoc) pill.textContent = "Location needed";
        else if (dist == null) pill.textContent = "Hall location not set";
        else {
          const rounded = Math.round(dist);
          pill.textContent = inside ? `Inside Â· ${rounded} ft` : `Outside Â· ${rounded} ft`;
        }

        right.appendChild(pill);
        titleRow.appendChild(left);
        titleRow.appendChild(right);

        const btn = document.createElement("button");
        btn.className = "openBtn";
        btn.textContent = (selectedHall?.id === h.id) ? "Close" : "Open";
        btn.onclick = () => {
          if (selectedHall?.id === h.id){
            selectedHall = null;
            stopLive();
            renderDetailsEmpty();
            renderHallList();
            return;
          }
          selectedHall = h;
          renderDetailsSelected();

          // keep the opened hall visible (donâ€™t jump to top/bottom)
          item.scrollIntoView({ behavior:"smooth", block:"nearest" });
        };

        item.appendChild(titleRow);
        item.appendChild(btn);

        // Inline detail panel (between halls) when selected
        if (selectedHall?.id === h.id){
          const inline = document.createElement("div");
          inline.className = "inlineDetail";

          const hdr = document.createElement("div");
          hdr.className = "inlineHdr";

          const hdrLeft = document.createElement("div");
          const t = document.createElement("div");
          t.className = "inlineTitle";
          t.textContent = h.name || h.id;

          const a = document.createElement("div");
          a.className = "inlineAddr";
          a.textContent = h.address || "";

          hdrLeft.appendChild(t);
          hdrLeft.appendChild(a);

          const hdrRight = document.createElement("span");
          hdrRight.className = "pill";
          hdrRight.textContent = (!myLoc) ? "Location not shared"
            : (dist == null) ? "Hall location not set"
            : inside ? `Inside radius Â· ${Math.round(dist)} ft` : `Outside radius Â· ${Math.round(dist)} ft`;

          hdr.appendChild(hdrLeft);
          hdr.appendChild(hdrRight);

          const grid = document.createElement("div");
          grid.className = "stageGrid";
          grid.dataset.inline = "1";

          const msg = document.createElement("div");
          msg.className = "note";

          // delegate clicks for inline vote buttons
          grid.onclick = (e) => {
            const b = e.target.closest("button.voteBtn");
            if (!b) return;
            vote(b.dataset.stageId);
          };

          inline.appendChild(hdr);
          inline.appendChild(grid);
          inline.appendChild(msg);

          item.appendChild(inline);

          // render inline content (uses selectedHall + liveStats)
          renderStagesInto(h, grid, msg);
        }

        box.appendChild(item);
      });
    }

    function renderDetailsEmpty(){
      el("detailTitle").textContent = "Select a hall";
      el("detailAddr").textContent = "";
      el("insidePill").textContent = myLoc ? "No hall selected" : "Location not shared";
      el("stagesWrap").style.display = "none";
    }

    async function renderDetailsSelected(){
      if (!selectedHall){ renderDetailsEmpty(); return; }

      el("detailTitle").textContent = selectedHall.name || selectedHall.id;
      el("detailAddr").textContent = selectedHall.address || "";

      const dist = hallDistanceFeet(selectedHall);
      const radius = hallRadiusFeet(selectedHall);
      const inside = !!myLoc && (dist != null) && (dist <= radius);

      if (!myLoc) el("insidePill").textContent = "Location not shared";
      else if (dist == null) el("insidePill").textContent = "Hall location not set";
      else el("insidePill").textContent = inside
        ? `Inside radius Â· ${Math.round(dist)} ft`
        : `Outside radius Â· ${Math.round(dist)} ft`;

      el("stagesWrap").style.display = "block";

      // start live stats for this hall/day
      startStageStatsListener();

      // initial render (will update again from live listener)
      renderStages();

      // list shows inline open panel under the hall
      renderHallList();
    }

    function formatTime(ts){
      if (!ts) return "â€”";
      try{
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      }catch{
        return "â€”";
      }
    }

    // Render stages into a given grid/message (used by right panel + inline panel)
    function renderStagesInto(hall, gridEl, msgEl){
      gridEl.innerHTML = "";
      if (!hall) return;

      const dist = hallDistanceFeet(hall);
      const radius = hallRadiusFeet(hall);
      const inside = !!myLoc && (dist != null) && (dist <= radius);

      const dayKey = liveDayKey || dayKeyFromReset(effectiveResetTimeLocal(hall));
      const stats = liveStats || {};

      DEFAULT_STAGES.forEach(st => {
        const s = stats[st.id] || {};
        const count = Number(s.count ?? 0);
        const last = s.lastVoteAt ? formatTime(s.lastVoteAt) : "â€”";

        const card = document.createElement("div");
        card.className = "stageCard";

        const name = document.createElement("div");
        name.className = "stageName";
        name.textContent = st.name;

        const statsLine = document.createElement("div");
        statsLine.className = "stageStats";
        statsLine.textContent = `ðŸ‘ ${count} Â· Last: ${last}`;

        const btn = document.createElement("button");
        btn.className = "voteBtn";
        btn.type = "button";
        btn.dataset.stageId = st.id;

        const voteKey = `voted:${hall.id}:${dayKey}:${st.id}`;
        const already = localStorage.getItem(voteKey) === "1";

        if (!inside){
          btn.disabled = true;
          btn.textContent = "View only";
        } else if (already){
          btn.disabled = true;
          btn.textContent = "Voted";
        } else {
          btn.disabled = false;
          btn.textContent = "ðŸ‘ Thumbs up";
        }

        card.appendChild(name);
        card.appendChild(statsLine);
        card.appendChild(btn);
        gridEl.appendChild(card);
      });

      if (!myLoc){
        msgEl.textContent = "View only. Share location to see inside/outside and to thumbs-up when inside.";
      } else if (dist == null){
        msgEl.textContent = "Hall location not set. Admin must add geo.lat / geo.lng.";
      } else if (!inside){
        msgEl.textContent = "Outside radius. You can view only.";
      } else {
        msgEl.textContent = "Inside radius. You can thumbs-up the current stage.";
      }
    }

    // Render stages (right panel) + keep inline panel refreshed
    function renderStages(){
      if (!selectedHall){
        renderDetailsEmpty();
        return;
      }

      // right panel events (delegate)
      el("stageGrid").onclick = (e) => {
        const b = e.target.closest("button.voteBtn");
        if (!b) return;
        vote(b.dataset.stageId);
      };

      renderStagesInto(selectedHall, el("stageGrid"), el("statusMsg"));

      // refresh inline open panel with current live counts/last time + buttons
      renderHallList();
    }

    // Vote writes to stageStats; live listener will update everyone's counts
    async function vote(stageId) {
      if (!selectedHall) return;
      if (!myLoc) { el("statusMsg").textContent = "Location required to vote."; return; }

      const dist = hallDistanceFeet(selectedHall);
      if (dist == null){ el("statusMsg").textContent = "Hall location not set."; return; }

      const radius = hallRadiusFeet(selectedHall);
      if (dist > radius){ el("statusMsg").textContent = "Outside radius. View only."; return; }

      const resetTime = effectiveResetTimeLocal(selectedHall);
      const dayKey = dayKeyFromReset(resetTime);
      liveDayKey = dayKey; // keep consistent

      const voteKey = `voted:${selectedHall.id}:${dayKey}:${stageId}`;
      if (localStorage.getItem(voteKey) === "1"){
        el("statusMsg").textContent = "Already voted on this stage.";
        return;
      }

      el("statusMsg").textContent = "Submitting voteâ€¦";
      clearErr();

      try {
        const statRef = doc(db, "halls", selectedHall.id, "days", dayKey, "stageStats", stageId);

        await setDoc(statRef, {
          count: increment(1),
          lastVoteAt: serverTimestamp()
        }, { merge: true });

        localStorage.setItem(voteKey, "1");

        el("statusMsg").textContent = "Vote recorded.";
        // No need to manually re-fetch: onSnapshot will update shortly
        renderStages();
      } catch (e) {
        showErr("Vote failed:\n" + (e?.message || String(e)));
        el("statusMsg").textContent = "Vote failed.";
      }
    }

    // Location
    async function requestLocation(){
      clearErr();
      if (!navigator.geolocation){
        showErr("Geolocation not supported on this device.");
        return;
      }

      el("locLine").textContent = "Requesting locationâ€¦";
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          myLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          myAccuracyFt = (pos.coords.accuracy || 0) * 3.28084;
          el("locLine").textContent = `Location set Â· accuracy ~${Math.round(myAccuracyFt)} ft`;

          // closest hall first now that we have location
          renderHallList();

          if (selectedHall){
            // dayKey might change if resetTime changed; restart listener
            startStageStatsListener();
            renderDetailsSelected();
          }
        },
        (err) => {
          showErr("Location error:\n" + (err?.message || String(err)));
          el("locLine").textContent = "Location: not granted";
          myLoc = null;
          myAccuracyFt = null;
          renderHallList();
          stopLive();
          renderDetailsSelected();
        },
        { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
      );
    }

    el("locBtn").onclick = requestLocation;
    el("searchInput").addEventListener("input", applySearch);

    // init
    await loadGlobalConfig();
    await loadHalls();
    renderDetailsEmpty();
  </script>
</body>
</html>
